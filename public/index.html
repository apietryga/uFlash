<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>uFlash v.1.0</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="inc/styles/main.css"/>
	</head>
	<body>
		<div class="loader">
		<!-- <center id="loader"> -->
			<img class="loader_img"  src='inc/img/loader.gif' loop=infinite />
		<!-- </center> -->
		</div>
		<!--
		<div style="z-index:6;position:fixed;" onclick="gestDone()">GEST</div>
		-->
	<!-- GESTURES -->
		<div id="gesture">
			<img id="ge0" class="gestPic" src="inc/img/gesture/0.png" />
			<img id="ge1" class="gestPic" src="inc/img/gesture/1.png" />
			<img id="ge2" class="gestPic" src="inc/img/gesture/2.png" />
			<img id="ge3" class="gestPic" src="inc/img/gesture/3.png" />
			<img id="ge4" class="gestPic" src="inc/img/gesture/4.png" /> 
<!-- 			
-->
		</div>
		<div class="gesture">
			<!-- <div class="gestureAnimationWrapper"> -->
				<div class="gestureAnimation">
					<svg width="33.954mm" height="33.98mm" version="1.1" viewBox="0 0 33.954 33.98" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
						<g transform="translate(-7.4995 -12.253)">
							<path d="m22.699 43.103c-2.3388-4.8411-1.6835-4.6095-6.002-2.1218-2.0262 1.1672-4.8089 2.7892-6.1839 3.6044-2.5718 1.5248-2.924 1.6716-2.924 1.2184 0-0.24278 1.9105-3.539 5.8841-10.152 0.86272-1.4357 1.4693-2.7063 1.348-2.8234s-1.8086-0.91322-3.7495-1.7691c-1.9409-0.85586-3.5482-1.6391-3.5719-1.7405-0.02366-0.10143 1.3843-0.84124 3.1289-1.644 1.7445-0.80278 3.3818-1.6695 3.6383-1.926 0.44546-0.44546 0.32868-0.70941-2.6028-5.8827-3.6032-6.3588-4.1553-7.4087-3.9855-7.5785 0.06955-0.06955 2.4889 1.2946 5.3763 3.0314 4.8167 2.8973 7.2843 4.2901 7.6008 4.2901 0.0677 0 0.90649-1.6214 1.864-3.6032 1.4889-3.0817 1.7981-3.5556 2.1364-3.2749 0.21754 0.18054 0.39553 0.43228 0.39553 0.55941 0 0.62559 2.7587 6.3186 3.0618 6.3186 0.37846 0 1.6271-0.70363 7.5215-4.2385 4.3331-2.5986 5.5548-3.2594 5.72-3.0942 0.063 0.06304-1.0301 2.0661-2.4293 4.4513-4.4988 7.6691-4.8783 8.3506-4.8783 8.7598 0 0.2622 1.187 0.92157 3.4063 1.8922 1.8734 0.81939 3.5403 1.4898 3.7042 1.4898s0.2969 0.14883 0.29566 0.33073c-1e-3 0.1819-0.9835 0.74008-2.1828 1.2404-3.4179 1.4259-5.2233 2.3754-5.2233 2.7474 0 0.18816 1.6657 3.1245 3.7016 6.5252 2.0359 3.4007 3.6492 6.2354 3.5852 6.2994-0.14911 0.14911-4.478-2.1626-7.7768-4.153-1.404-0.84711-3.1978-1.8664-3.9864-2.2651l-1.4337-0.72487-0.47 0.62237c-0.2585 0.3423-1.0373 1.9703-1.7308 3.6177-0.69343 1.6474-1.352 3.0517-1.4635 3.1206-0.11148 0.0689-0.90986-1.3385-1.7742-3.1276zm4.2234-7.3539c0.29519 0 1.8588 0.65638 3.4747 1.4586 1.6159 0.80225 2.987 1.4096 3.0469 1.3497 0.12311-0.12311-0.99009-2.376-2.4174-4.8924-1.1039-1.9461-1.0888-1.9916 1.0675-3.2254 0.78331-0.44817 1.4238-0.95494 1.4233-1.1262-5.3e-4 -0.17122-0.66481-0.6685-1.4762-1.1051-0.81142-0.43656-1.5818-0.92131-1.712-1.0772-0.14838-0.17767 0.35644-1.4993 1.3526-3.5412 0.87413-1.7917 1.5372-3.3098 1.4736-3.3735-0.0637-0.06368-1.355 0.60711-2.8696 1.4906-1.5146 0.88353-2.9844 1.6056-3.2663 1.6046-0.48486-0.0017-0.86736-0.46438-2.1666-2.6207l-0.54394-0.90276-0.7976 1.58c-1.2454 2.4672-1.0829 2.4518-4.9213 0.46465-1.852-0.95876-3.4314-1.679-3.5099-1.6006s0.52571 1.5656 1.3426 3.3048c0.81689 1.7392 1.4853 3.3541 1.4853 3.5888 0 0.25429-0.58794 0.71503-1.4552 1.1404-0.80036 0.39254-1.4552 0.85994-1.4552 1.0387 0 0.17873 0.61541 0.65994 1.3676 1.0694 2.1631 1.1774 2.1645 1.2017 0.27771 4.8804-0.90869 1.7717-1.6067 3.2668-1.5511 3.3223 0.05557 0.05557 1.409-0.60406 3.0077-1.4658 4.1306-2.2266 3.755-2.2367 4.9269 0.13168l1.0006 2.0222 1.1794-1.7581c0.80658-1.2023 1.3491-1.7581 1.7161-1.7581z"
								stroke-width=".26458" fill="var(--light)"/>
							</g>
					</svg>
				</div>
			<!-- </div> -->
		</div>
		<div class="btns">
			<button onclick="newGesture(0)">B0</button>
			<button onclick="newGesture(1)">B1</button>
			<button onclick="newGesture(2)">B2</button>
			<button onclick="newGesture(3)">B3</button>
			<button onclick="newGesture(4)">B4</button>
		</div>


	<!-- END OF GESTURES -->
		<table id="mainscene">
			<tr>
				<td class="mainsceneTD">
					<div id="disMess"></div>
					<div id="countP"></div>
				</td>
			</tr>
			<tr>
				<td id="odliczField"></td>
			</tr>
		</table>
	<!-- FUNKCYJNE -->
		<div id="plotter"></div>
		<div id="dodruk"></div>
		<div id="gestVal" style="color:#fff;position:absolute;top:0;left:0;font-size:10em;z-index:2;"></div>
		<div id="gestVal2" style="color:#fff;position:absolute;top:100px;left:0;font-size:10em;z-index:2;"></div>
		<div class="camDIV">
			<div id="message">Ładowanie ... </div>
			<video id="webcam" autoplay width="640" height="480"></video>
			<canvas id="canvas-source" width="640" height="480" style="margin-top: 12%; margin-left: 25%; border: 4px solid #999; padding: 2px;"></canvas>
			<canvas id="canvas-blended" width="640" height="480"></canvas>
			<div id="buttons"  style="margin-top: 12%; margin-left: 25%; border: none;">
				<div id="front">
					<img id="button0" src="inc/img/gesture/b1.png"/>
					<img id="button1" src="inc/img/gesture/b2.png"/>
					<img id="button2" src="inc/img/gesture/b4.png"/>
					<img id="button3" src="inc/img/gesture/b.png"/>
				</div>
			</div>
		</div>
		<div class="results">
		</div>
		<!-- do renderów -->
		<input id="filledTemplate" name="file" style='display:none;'/>
		<!-- end of do renderów -->	
	<!-- END OF FUNKCYJNE -->
	</body>
<script src="inc/js/jquery.js"></script>
<script src="inc/js/buffer-loader.js"></script>
<script src="inc/js/html2canvas.js"></script>
<script src="inc/js/app.js"></script>
<script src="inc/js/face_recognition.js"></script>

<script>
	window.odliczOD = 10; // ODLICZANIE SEC. 
	/* ^^poprawić na 10*/
	window.fotaPO = 5; // PO ILU MA WEJŚĆ CAPTURE SEC
	/* ^^poprawić na 5*/
	window.RobieFoto = 0; // app.js
	window.lastCaptured = 0;
	window.photox = [];
	window.nrofpic = 0;	
	window.kolejkaDruku = 0;
	window.allowScreen6 = false;
	function displayScreen(id,x = 0){
		console.log("SCREEN ID: "+id);
		val = "";
		if(id == 0){
			document.getElementById("gesture").style.display = "flex";
			document.getElementById("ge0").style.display = "block";
			newGesture(0);
		}
		if(id == 1){
			ledON();
			document.getElementById("ge4").style.display = "block";
			document.getElementById("gesture").style.display = "flex";
			setTimeout(function(){
				document.getElementById("gesture").style.display = "none";
				document.getElementById("ge4").style.display = "none";
				val = "PIERWSZE ZDJĘCIE ZA<br />";
				document.getElementById("disMess").innerHTML = val;
				odlicz(window.odliczOD,id);			
			},1000);
			
		}
		if(id == 2){
			document.getElementById("countP").innerHTML = "";
			val = "DRUGIE ZDJĘCIE ZA";
			odlicz(window.odliczOD,id);
		}
		if(id == 3){
			document.getElementById("countP").innerHTML = "";
			val = "OSTATNIE ZDJĘCIE ZA";
			odlicz(window.odliczOD,id);
		}
		if(id == 4){
			ledOFF();
			document.getElementById("countP").innerHTML = "";
			val += "LICZĘ OSOBY NA ZDJĘCIU";
			console.log("PREPARING PHOTO TEMPLATE");
			src = "inc/img/captured_small/small_"+window.lastCaptured;
			console.log("IMG SRC: "+src);
			fDetect(src,function(){
				setPhoto(function(){
					renderPicture(function() {
						for(x = 0; x < window.osoby; x++){
							drukuj();
						}
						displayScreen(5);
					});
				});
			});
		}
		if(id == 6){
			val += "ODBIERZ ZDJĘCIA";	
			odbior = setTimeout(function(){
				window.RobieFoto = 0;
				displayScreen(0);
				checkGest(0);
				clearTimeout(odbior);
				var liczGest = setInterval(myTimer, 1000);				
			},5000)
		}
		if(id != 5){
			document.getElementById("disMess").innerHTML = val;
		}else{
			checkPrint(function() {
				if(window.kolejkaDruku == 0 && window.allowScreen6 == true){
					window.allowScreen6 = false;
				}else{
					if(window.kolejkaDruku != 0){
						val += "DRUKUJĘ "+window.kolejkaDruku+" ZDJĘĆ";
						document.getElementById("disMess").innerHTML = val;
						displayScreen(5);
					}
				}
			}); 
		}
	}
	function capture(id){
		document.getElementById("loader").style.display = "block";
		var t0 = performance.now();
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {				
				var t1 = performance.now();
				document.getElementById("loader").style.display = "none";
				window.lastCaptured = this.responseText;
				console.log("CAPTURE TIME: " + Math.round(((t1 - t0)/1000)*100)/100 + " SEC");
				displayScreen(id+1);
			}
		};
	  xhttp.open("GET", "inc/php/functions.php?capture=true", true);
	  xhttp.send();
	}
	function setPhoto(_callback){
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			phtx = eval(this.responseText);
			drawImage('5x15',phtx);
			_callback();
		}
	  };
	  xhttp.open("GET", "inc/php/functions.php?photos=true", true);
	  xhttp.send();		
	}
	function ledON(_callback){
	console.log("LED ON");
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
	//		_callback();
		}
	  };
	  xhttp.open("GET", "inc/php/functions.php?led=on", true);
	  xhttp.send();		
	}
	function ledOFF(_callback){
		console.log("LED OFF");
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
	//		_callback();
		}
	  };
	  xhttp.open("GET", "inc/php/functions.php?led=off", true);
	  xhttp.send();		
	}
	function drukuj(){
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
		//	displayScreen(5);
		}
	  };
	  xhttp.open("GET", "inc/php/functions.php?print=true", true);
	  xhttp.send();					
	}
	function checkPrint(_callback){
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			if(this.responseText == 0){
				setTimeout(function(){
					displayScreen(6);
				},1000);
			}
			window.kolejkaDruku = this.responseText;
			_callback();
		}
	  };
	  xhttp.open("GET", "inc/php/functions.php?checkstatus=true", true);
	  xhttp.send();					
	}	
	function drawImage(size,pht,side = 'center'){
	// obszar drukowanego zdjęcia:
		var dodruk = document.createElement('DIV');
		dodruk.style.width = '2400px';
		dodruk.style.height = '3600px';
		dodruk.style.backgroundColor = "#fff";
	//template1
		var templateDIV = document.createElement('DIV');
		templateDIV.id = "temp1";
		templateDIV.style.position = "absolute";
		templateDIV.style.zIndex = "2";
	// nakładamy template:	
		var templateIMG = document.createElement('IMG');
		templateIMG.style.position = "absolute";
		templateIMG.src = "inc/img/templates/"+pht[3];
		templateIMG.style.width = "1200px";
		templateIMG.style.height = "3600px";
		templateIMG.style.zIndex = "1";
			
		templateDIV.appendChild(templateIMG);
		dodruk.appendChild(templateDIV);
	// zrobione zdjęcia
		photo = [];
		for(x = 0; x <= 2; x++){
			photo[x] = document.createElement('IMG');
			photo[x].src = pht[x];
			photo[x].style.zIndex = "2";
			photo[x].style.position = "absolute";
			photo[x].style.offsetLeft = "1200px";
			photo[x].style.width = "1006px";
			photo[x].style.height = "670px";
			photo[x].style.margin = "100px 0 0 100px";
			if(x == 1){
				photo[x].style.marginTop = "870px";
			}
			if(x == 2){
				photo[x].style.marginTop = "1640px";
			}
			templateDIV.appendChild(photo[x]);
		}
	// dublujemy zdjęcie i wstawiamy je obok (tylko przy 10x15)
		if(size == "10x15"){
			var templateDIV2 = document.createElement('DIV');
			templateDIV2.id = "temp2";
			templateDIV2.style.position = "absolute";
			templateDIV2.style.zIndex = "2";
			templateDIV2.style.marginLeft = "600px";
			dodruk.appendChild(templateDIV2);
		}
	// ustawiamy zdjęcie w dobrym miejscu (tylko 5x15)	
		if(size == "5x15"){
			if(side == "right"){
				templateDIV.style.marginLeft = "370px";
			}
			if(side == "center"){
//				templateDIV.style.marginLeft = "92.5px";
				templateDIV.style.marginLeft = "600px";
			}
		}
	// wpinamy wszystko do diva dodruk
		var dd = document.getElementById("plotter");
		dd.innerHTML = "";
		dd.appendChild(dodruk);
	
	//uzupełniamy drugie foto:
		if(size == "10x15"){
			document.getElementById('temp2').innerHTML = document.getElementById('temp1').innerHTML;
		}
	}
	function renderPicture(_callback){
		var divname = "plotter";
		var div = document.getElementById(divname);
		html2canvas([div], {
			onrendered: function(canvas) {
			   var src = canvas.toDataURL('image/png');
				var formdata = new FormData();
				var divId = document.getElementById("filledTemplate");
				formdata.append(divId.name, src);
				var xmlhttp;
				if(window.XMLHttpRequest){
					xmlhttp = new XMLHttpRequest;
				}else{
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				}
				xmlhttp.onreadystatechange = function(){
				   if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
						div.style.display = "none";
						_callback();
				   }
				}
				xmlhttp.open("POST", "inc/php/functions.php?upload=true");
				xmlhttp.send(formdata);
				
			}
		});
	}
	function newGesture(id){
		let gA = document.querySelector(".gestureAnimation")
		gA.classList = ["gestureAnimation"]
		gA.classList.add("ga" + id)

		for(x = 0; x <= 3; x++){
			document.getElementById("ge"+x).style.display = "none";
		}
		if(id < 4){
			document.getElementById("ge"+id).style.display = "block";
		}
	}
	function fade(element) {
		var op = 1;  // initial opacity
		var timer = setInterval(function () {
			if (op <= 0.1){
				clearInterval(timer);
				element.style.display = 'none';
			}
			element.style.opacity = op;
			element.style.filter = 'alpha(opacity=' + op * 100 + ")";
			op -= op * 0.1;
		}, 50);
	}
	function odlicz(x,nr_zdjecia){
		window.czas = x;
		window.intervalx = setInterval(function(){
			odliczanie(x,nr_zdjecia);
			window.czas--;
		},1000);
	}
	function odliczanie(x,nr_zdjecia){
		document.getElementById("countP").innerHTML = window.czas;
		if (window.czas < window.fotaPO){
			console.log("SENDING CAPTURE "+nr_zdjecia);
			capture(nr_zdjecia);
			clearInterval(window.intervalx);
			document.getElementById("disMess").innerHTML = "";
		}
	}
	window.gestNote = 0;
	window.lGn = 0; 
	window.stoptimer = 0;
	var liczGest = setInterval(myTimer, 200);
	function checkGest(id){
		if(window.stoptimer == 1){
			window.stoptimer = 0;
			if(window.gestNote == 3 && id == 3){
				if(window.RobieFoto == 0){
					window.RobieFoto = 1;
					window.gestNote = 4;
					console.log("GESTURE PASSED");
					skonczGest();
					displayScreen(1);
					// BANG
				}
			}else if(window.gestNote == id){
				window.gestNote++;
			}else if(window.gestNote == id+1 ){
				// next step to BANG! 
			}else{
				window.gestNote = 0;
			}
			document.getElementById("gestVal").innerHTML = "["+window.gestNote+"]";
			newGesture(window.gestNote);
		}
	}
	function myTimer(){
		window.stoptimer = 1;
	}
	function skonczGest(){
		document.getElementById("gesture").style.display = "none";
		clearInterval(liczGest);		
	}
	function faceRec(){
		return 1;
	}
	window.onload = start_media();
	displayScreen(0);
	// development
	function gestDone(){
		window.stoptimer = 1;
		window.RobieFoto = 0;
		window.gestNote = 3;
		checkGest(3);
	}
	// end of development
	// wykrywanie twarzy
	function renderImg(src,_callback){
		var div = document.createElement("div");
		div.id = "dCoint";
		div.className = "detect-contrainer";
		var img = document.createElement("img");
		img.id = "img";
		img.src = src;
		div.appendChild(img);
		document.body.appendChild(div);
		setTimeout(function(){
			_callback();
		},100)
	}
	function facedetection(_callback){
		window.osoby = 0;
		var img = document.getElementById('img'); 
		var tracker = new tracking.LandmarksTracker();
		tracker.setInitialScale(4);
		tracker.setStepSize(2);
		tracker.setEdgesDensity(0.1);
		tracking.track('#img', tracker);
		tracker.on('track', function(event) {
				if(!event.data) return;
				event.data.faces.forEach(function(rect) {
				window.osoby++;		
			});
		});
		setTimeout(function(){
			_callback();
		},100);
	}
	function fDetect(src,_callback){
		renderImg(src,function(){
			facedetection(function(){
				console.log("DETECT "+window.osoby+" PERSON/S");
				_callback();
			});
		});
	}
</script>

<script>
// debug development
// displayScreen(1, 0)
newGesture(2)


</script>
</html>